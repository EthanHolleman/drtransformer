#!/usr/bin/env python3

import RNA
import unittest
from itertools import combinations

import drtransformer
from drtransformer.utils import make_pair_table
from drtransformer.pathfinder import (get_bpd_cache, 
                                  get_bpd_i_cache,
                                  findpath_split,
                                  print_barfile,
                                  common_basepairs,
                                  common_exterior_bases, 
                                  split_struct,
                                  merge_struct,
                                  path_flooding, 
                                  edge_flooding,
                                  get_guide_graph,
                                  guiding_edge_search,
                                  guiding_node_search,
                                  forbid_all_basepairs,
                                  get_basepairs,
                                  mfe_intersect,
                                  neighborhood_flooding,
                                  top_down_coarse_graining)

SKIP = False

@unittest.skipIf(SKIP, "skipping tests")
class FindpathTests(unittest.TestCase):
    def test_split_merge_01(self):
        seq = 'GCCUUAAGCCUACUUAGAUGGAAGUGACGUACGGGUAUU'
        ss1 = '(......((((((((......)))).......))))..)'
        ss2 = '((((.......((((......)))).......)))...)'
        pt1 = make_pair_table(ss1, base = 0)
        pt2 = make_pair_table(ss2, base = 0)

        ceb = []
        assert list(common_exterior_bases(pt1, pt2)) == ceb
        for x in common_exterior_bases(pt1, pt2):
            assert seq == merge_struct(*split_struct(seq, x, None), x, None)
            assert ss1 == merge_struct(*split_struct(ss1, x, None), x, None)
            assert ss2 == merge_struct(*split_struct(ss2, x, None), x, None)

        cbp = [(0, 38), (11, 24), (12, 23), (13, 22), (14, 21)]
        assert list(common_basepairs(pt1, pt2)) == cbp
        for x in common_basepairs(pt1, pt2):
            assert seq == merge_struct(*split_struct(seq, *x), *x)
            assert ss1 == merge_struct(*split_struct(ss1, *x), *x)
            assert ss2 == merge_struct(*split_struct(ss2, *x), *x)

    def test_split_merge_02(self):
        seq = 'AAAGCCGCCUUAAACGGGUAUUGGUACCNNNGGCAAGCCGCCUUAAGCCUACUUAGAUGGAAGUGACGUACGGGUAUUGGUAC'
        ss1 = '...((((.(((....)))...)))).((...))...((((.(((..((.(((((......)))))..))..)))...))))..'
        ss2 = '....((((((.....))))...))..((...))....((((((.......((((......)))).......))))...))...'
        pt1 = make_pair_table(ss1, base = 0)
        pt2 = make_pair_table(ss2, base = 0)

        ceb = [0, 1, 2, 25, 33, 34, 35, 81, 82]
        assert list(common_exterior_bases(pt1, pt2)) == ceb
        for x in common_exterior_bases(pt1, pt2):
            assert seq == merge_struct(*split_struct(seq, x, None), x, None)
            assert ss1 == merge_struct(*split_struct(ss1, x, None), x, None)
            assert ss2 == merge_struct(*split_struct(ss2, x, None), x, None)

        cbp = [(4, 23), (5, 22), (26, 32), (27, 31), (37, 79), (38, 78), (50, 63), (51, 62), (52, 61), (53, 60)]
        assert list(common_basepairs(pt1, pt2)) == cbp
        for x in common_basepairs(pt1, pt2):
            assert seq == merge_struct(*split_struct(seq, *x), *x)
            assert ss1 == merge_struct(*split_struct(ss1, *x), *x)
            assert ss2 == merge_struct(*split_struct(ss2, *x), *x)

    def test_findpath_split_00(self):
        seq = 'GCCUUAAGCCUACUUAGAUGGAAGUGACGUACGGGUAUU'
        ss1 = '(......((((((((......)))).......))))..)'
        ss2 = '((((.......((((......)))).......)))...)'
        # Set model details.
        path, barrier = findpath_split(seq, ss1, ss2, RNA.md())
        assert path == [('(......((((((((......)))).......))))..)', 400),
                        ('(.......(((((((......)))).......)))...)', 600),
                        ('(.......((.((((......))))........))...)', 860),
                        ('(........(.((((......))))........)....)', 1210),
                        ('(..........((((......)))).............)', 680),
                        ('((.........((((......)))).........)...)', 770),
                        ('(((........((((......))))........))...)', 430),
                        ('((((.......((((......)))).......)))...)', 280)]
        assert barrier == max((en for ss, en in path)) - path[0][1]

    def test_findpath_split_01(self):
        seq = 'AAAGCCGCCUUAAGCCUACUUAGAUGGAAGUGACGUACGGGUAUUGGUACACGAUUUUACAAAGCCGCCUUAAGCCUACUUAGAUGGAAGUGACGUACGGGUAUUGGUACACGAUUUUAC'
        ss1 = '...((((.(((..((.(((((......)))))..))..)))...))))...............((((.(((..((.(((((......)))))..))..)))...))))............'
        ss2 = '...(((((((.......((((......)))).......))))...)))...............(((((((.......((((......)))).......))))...)))............'
       #ss2 = '....((((((.......((((......)))).......))))...)).................((((((.......((((......)))).......))))...)).............'
        vrna_md = RNA.md()
        #print(f'\n{seq}\n{ss1}\n{ss2}')
        path, barrier = findpath_split(seq, ss1, ss2, vrna_md, th = 99)
        assert path == [('...((((.(((..((.(((((......)))))..))..)))...))))...............((((.(((..((.(((((......)))))..))..)))...))))............', -1140),
                        ('...((((.(((..((.(((((......)))))..))..)))...))))...............((((.(((...(.(((((......)))))..)...)))...))))............', -860),
                        ('...((((.(((..((.(((((......)))))..))..)))...))))...............((((.(((.....(((((......)))))......)))...))))............', -970),
                        ('...((((.(((..((.(((((......)))))..))..)))...))))...............((((.((......(((((......))))).......))...))))............', -900),
                        ('...((((.(((..((.(((((......)))))..))..)))...))))...............((((.(.......(((((......)))))........)...))))............', -750),
                        ('...((((.(((..((.(((((......)))))..))..)))...))))...............((((.........(((((......)))))............))))............', -820),
                        ('...((((.(((..((.(((((......)))))..))..)))...))))...............(((((........(((((......)))))........)...))))............', -730),
                        ('...((((.(((..((.(((((......)))))..))..)))...))))...............((((((.......(((((......))))).......))...))))............', -1070),
                        ('...((((.(((..((.(((((......)))))..))..)))...))))...............(((.((.......(((((......))))).......))....)))............', -920),
                        ('...((((.(((..((.(((((......)))))..))..)))...))))...............((((((.......(((((......))))).......)))...)))............', -1180),
                        ('...((((.(((..((.(((((......)))))..))..)))...))))...............(((((((......(((((......)))))......))))...)))............', -1340),
                        ('...((((.(((...(.(((((......)))))..)...)))...))))...............(((((((......(((((......)))))......))))...)))............', -1060), 
                        ('...((((.(((.....(((((......)))))......)))...))))...............(((((((......(((((......)))))......))))...)))............', -1170),
                        ('...((((.((......(((((......))))).......))...))))...............(((((((......(((((......)))))......))))...)))............', -1100),
                        ('...((((.(.......(((((......)))))........)...))))...............(((((((......(((((......)))))......))))...)))............', -950),
                        ('...((((.........(((((......)))))............))))...............(((((((......(((((......)))))......))))...)))............', -1020),
                        ('...(((((........(((((......)))))........)...))))...............(((((((......(((((......)))))......))))...)))............', -930),
                        ('...((((((.......(((((......))))).......))...))))...............(((((((......(((((......)))))......))))...)))............', -1270),
                        ('...(((.((.......(((((......))))).......))....)))...............(((((((......(((((......)))))......))))...)))............', -1120),
                        ('...((((((.......(((((......))))).......)))...)))...............(((((((......(((((......)))))......))))...)))............', -1380),
                        ('...(((((((......(((((......)))))......))))...)))...............(((((((......(((((......)))))......))))...)))............', -1540),
                        ('...(((((((.......((((......)))).......))))...)))...............(((((((......(((((......)))))......))))...)))............', -1420),
                        ('...(((((((.......((((......)))).......))))...)))...............(((((((.......((((......)))).......))))...)))............', -1300)]
        assert barrier == max((en for ss, en in path)) - path[0][1]
        #for (ss, en) in path:
        #    print(f'{ss} {en:>5d}')
        path, barrier = findpath_split(seq, ss1, ss2, vrna_md, th = 5)
        assert barrier == 410
        #for (ss, en) in path:
        #    print(f'{ss} {en:>5d}')
        path, barrier = findpath_split(seq, ss1, ss2, vrna_md, th = 1)
        assert barrier == 410
        #for (ss, en) in path:
        #    print(f'{ss} {en:>5d}')

    def test_findpath_split_02(self):
        seq = "UGGGAAUAGUCUCUUCCGAGUCUCGCGGGCGACGGGCGAUCUUCGAAAGUGGAAUCCG"
        ss1 = "..((....(((........(((.....)))....)))..(((........)))..))." 
        ss2 = ".((((....))))..(((.(.((...)).)..)))......(((.......)))...."
        path, barrier = findpath_split(seq, ss1, ss2, RNA.md(), th = 1)
        assert barrier == 200 # may change with a new findpath version?

@unittest.skipIf(SKIP, "skipping tests")
class ConstrainedFoldingTests(unittest.TestCase):
    def test_mfe_intersect(self):
        seq = "UGGGAAUAGUCUCUUCCGAGUCUCGCGGGCGACGGGCGAUCUUCGAAAGUGGAAUCCG"
        ss1 = "..((....(((........(((.....)))....)))..(((........)))..))." 
        ss2 = ".((((....))))..(((.(.((...)).)..)))......(((.......)))...."
        bps = get_basepairs([ss1, ss2])
        mss, mfe = mfe_intersect(seq, RNA.md(), bps)
        assert mss != ss1
        assert mss != ss2

    def test_mfe_intersect(self):
        seq = "UGGGAAUAGUCUCUUCCGAGUCUCGCGGGCGACGGGCGAUCUUCGAAAGUGGAAUCCG"
        ss1 = "..((....(((........(((.....)))....)))..(((........)))..))." 
        ss2 = ".((((....))))..(((.((((...))))..)))....(((........)))....."
        bps = get_basepairs([ss1, ss2])
        mss, mfe = mfe_intersect(seq, RNA.md(), bps)
        assert mss == ss2
 
    def test_mfe_intersect(self):
        seq = 'UCCGACAUUAAGACACACCAGGGUCUCGUAUCCCUAGGGUAAGGUACGCGCGGACCGGCCAAUCGGGUAUUGCUGCAAACUAUGGCAAUAGUGCAUAGGUUCAGACGAAGUACGGGUGGAUAUUUGUAGCCAGUAUGCUGGGUCUCCGGG'
        ss1 = '((((..........((.((((((........)))).))))..........))))((((...(((.(((((.((((((((((((.(((....)))))))(((((..((.....))..))))).))))))))....))))).)))..)))).'
        ss2 = '((((..........((.((((((........)))).))))..........))))((((....((((((((((((((((((((((((....)).)))))(((((..((.....))..))))).)))))))).))))).))))....)))).'
        ss3 = '((((..........((.((((((........)))).))))..........))))((((....((((((((((((((((((((((.((....)))))))(((((..((.....))..))))).)))))))).))))).))))....)))).'
        bps = get_basepairs([ss1, ss2, ss3])
        mss, mfe = mfe_intersect(seq, RNA.md(), bps)
        assert mss == ss3

@unittest.skipIf(True, "skipping tests")
class NeighborhoodTests(unittest.TestCase):
    def test_bpd_i_cache(self):
           p = '.((((.((((.((...(((...).))...))))))..))))...'
           i = '.((((.((((........(...)........))))..))))...'
           q = '.((((.((((.((...))(...).((...))))))..))))...'
           assert get_bpd_cache(p, i) == get_bpd_i_cache(p, q)
           assert get_bpd_cache(i, q) == get_bpd_i_cache(q, p)
           assert get_bpd_i_cache(p, i) == get_bpd_i_cache(p, q)
           assert get_bpd_i_cache(q, i) == get_bpd_i_cache(q, p)
           assert get_bpd_i_cache(i, p) == 0
           assert get_bpd_i_cache(i, q) == 0

    def test_guiding_edge_search_01(self):
        sss = ["..........((((.....((((.((.........)).)))).))))...",
               "...((((...)))).....((((.((.........)).))))........",
               ".(((......)))......((((.((.........)).))))........"]
        edges = guiding_edge_search(sss)
        assert len(edges) == 4

    def test_guiding_edge_search_02(self):
        # NOTE: I did not actually check if this is correct.
        btree = """
              AGACGACAAGGUUGAAUCGCACCCACAGUCUAUGAGUCGGUGACAACAUU
            1 ..........((((.((((.((.((.......)).))))))..))))...  -6.70    0  13.00
            2 ..........((((.((((.((...((.....)).))))))..))))...  -6.10    1   2.10
            3 ..........((((.....((((.((.........)).)))).))))...  -5.90    1   6.30
            4 ((((.....(((........)))....))))....(((...)))......  -5.70    1   8.50
            5 ...((((...)))).....((((.((.........)).))))........  -5.60    3   4.80
            6 .(((......)))......((((.((.........)).))))........  -5.50    5   4.30
            7 ..........((((..((((.....((.....)).....))))))))...  -5.50    3   5.30
            8 ((((.....(((........)))....))))...................  -5.00    4   3.40
            9 ((((.....((.((.....))))....))))....(((...)))......  -5.00    4   2.80
           10 ((((.....((.((.....)).))...))))....(((...)))......  -4.90    4   3.50
        """
        lmins = parse_barriers(btree, is_file = False, return_tuple = True)
        sti = {x.structure: x.id for x in lmins[1:]}
        edges = guiding_edge_search(sti.keys())
        #print()
        #for (x, y) in sorted(edges, key=lambda x: (sti[x[0]], sti[x[1]])):
        #    if sti[x] < sti[y]:
        #        print(sti[x], sti[y], x, y)
        assert len(edges) == 22

    def test_guiding_edge_search_03(self):
        seq = "AGACGACAAGGUUGAAUCGCA"
        sss = """(.((......)))........
                 .((((((...))))..))...
                 .(((......)))........
                 .((...((....))..))...
                 .(.(((((....))..)))).
                 .(.((((...))))..)....
                 .(.(((..........)))).
                 .(.((............))).
                 ...(((((....))..)))..
                 ...((((...)))).......
                 ...((((......)..)))..
                 ...(((..........)))..
                 ...((............))..
                 ....................."""
 
        sti = {s: e for e, s in enumerate(sss.split(), 1)}
        #print(len(sti))
        #for ss in sti:
        #    print(sti[ss], ss)
        edges = guiding_edge_search(set(sti.keys()))
        #print()
        #for (x, y) in sorted(edges, key=lambda x: (sti[x[0]], sti[x[1]])):
        #    if sti[x] < sti[y]:
        #        print(sti[x], sti[y], x, y)
        assert len(edges) == 36

    def test_guide_graph_construction(self):
        btree = """
              AGACGACAAGGUUGAAUCGCACCCACAGUCUAUGAGUCGGUGACAACAUU
            #1 ..........((((.((((.((.((.......)).))))))..))))...  -6.70    0  13.00
            2 ..........((((.((((.((...((.....)).))))))..))))...  -6.10    1   2.10
            3 ..........((((.....((((.((.........)).)))).))))...  -5.90    1   6.30
            #4 ((((.....(((........)))....))))....(((...)))......  -5.70    1   8.50
            5 ...((((...)))).....((((.((.........)).))))........  -5.60    3   4.80
            6 .(((......)))......((((.((.........)).))))........  -5.50    5   4.30
            #7 ..........((((..((((.....((.....)).....))))))))...  -5.50    3   5.30
            8 ((((.....(((........)))....))))...................  -5.00    4   3.40
            #9 ((((.....((.((.....))))....))))....(((...)))......  -5.00    4   2.80
           #10 ((((.....((.((.....)).))...))))....(((...)))......  -4.90    4   3.50
        """
        lmins = parse_barriers(btree, is_file = False, return_tuple = True)
        seq, md = lmins[0], RNA.md()
        ndata = {x.structure: {'energy': int(round(x.energy*100)), 'identity': x.id} for x in lmins[1:]}

        nodes, edges = get_guide_graph(seq, md, ndata.keys())
        assert all(n not in ndata for n in nodes)
        assert len(edges) == 16

@unittest.skipIf(SKIP, "skipping tests")
class TopDown(unittest.TestCase):
    def test_top_down_coarse_graining_direct_paths(self):
        seq = "UCUACUAUUCCGGCUUGACAUAAAUAUCGAGUGCUCGACCGCUAUUAUGGUACUUUCCAGCGUUUUGAUUGGUGGAUAAUAUCCCCCAAAAACGCGAGUC"
        path = [('............(((((..........)))))((((..((........)).........((((((...((((.((((...)))).)))))))))))))).', -1850), # lmin
                ('............(((((..........))))).(((..((........)).........((((((...((((.((((...)))).)))))))))))))..', -1710),
                ('............(((((..........)))))..((..((........)).........((((((...((((.((((...)))).))))))))))))...', -1440),
                ('............(((((..........)))))...(..((........)).........((((((...((((.((((...)))).)))))))))))....', -1300), # saddle
                ('............(((((..........)))))......((........)).........((((((...((((.((((...)))).)))))))))).....', -1660), # lmin
                ('............(((((..........))))).......(........)..........((((((...((((.((((...)))).)))))))))).....', -1370),
                ('............(((((..........)))))...........................((((((...((((.((((...)))).)))))))))).....', -1620),
                ('...........((((((..........))))).......)...................((((((...((((.((((...)))).)))))))))).....', -1230),
                ('..........(((((((..........))))).......))..................((((((...((((.((((...)))).)))))))))).....', -1390),
                ('..........((.((((..........))))........))..................((((((...((((.((((...)))).)))))))))).....', -1110), # saddle
                ('..........(((((((..........)))).......)))..................((((((...((((.((((...)))).)))))))))).....', -1520), # lmin
                ('....(.....(((((((..........)))).......)))........).........((((((...((((.((((...)))).)))))))))).....', -1100), # saddle
                ('....((....(((((((..........)))).......))).......)).........((((((...((((.((((...)))).)))))))))).....', -1260),
                ('....(((...(((((((..........)))).......)))......))).........((((((...((((.((((...)))).)))))))))).....', -1380),
                ('....((((..(((((((..........)))).......))).....)))).........((((((...((((.((((...)))).)))))))))).....', -1580),
                ('...(((((..(((((((..........)))).......))).....)))))........((((((...((((.((((...)))).)))))))))).....', -1720), # lmin
                ('...(((((..((((((............))).......))).....)))))........((((((...((((.((((...)))).)))))))))).....', -1440),
                ('...(((((..(((((..............)).......))).....)))))........((((((...((((.((((...)))).)))))))))).....', -1280),
                ('...(((((..((((................).......))).....)))))........((((((...((((.((((...)))).)))))))))).....', -1140), # saddle
                ('...(((((..(((.........................))).....)))))........((((((...((((.((((...)))).)))))))))).....', -1560),
                ('...(((((..(((...(..................)..))).....)))))........((((((...((((.((((...)))).)))))))))).....', -1380),
                ('...(((((..(((..((..................)).))).....)))))........((((((...((((.((((...)))).)))))))))).....', -1480),
                ('...(((((..(((.(((..................)))))).....)))))........((((((...((((.((((...)))).)))))))))).....', -1750),
                ('...(((((..(((.((((................))))))).....)))))........((((((...((((.((((...)))).)))))))))).....', -1870),
                ('...(((((..(((.(((((.............).))))))).....)))))........((((((...((((.((((...)))).)))))))))).....', -1860),
                ('...(((((..(((.((((((...........)).))))))).....)))))........((((((...((((.((((...)))).)))))))))).....', -1950),
                ('...(((((..(((.(((((((.........))).))))))).....)))))........((((((...((((.((((...)))).)))))))))).....', -2150),
                ('..((((((..(((.(((((((.........))).))))))).....)))))).......((((((...((((.((((...)))).)))))))))).....', -2270), # lmin
                ('..((((((..(((.(((((((.........))).))))))).....)))))).....(.((((((...((((.((((...)))).)))))))))))....', -2140),
                ('..((((((..(((.(((((((.........))).))))))).....)))))).....(..(((((...((((.((((...)))).))))))))).)....', -1710)]

        lmins = ['............(((((..........)))))((((..((........)).........((((((...((((.((((...)))).)))))))))))))).', 
                 '............(((((..........)))))......((........)).........((((((...((((.((((...)))).)))))))))).....',
                 '..........(((((((..........)))).......)))..................((((((...((((.((((...)))).)))))))))).....',
                 '...(((((..(((((((..........)))).......))).....)))))........((((((...((((.((((...)))).)))))))))).....',
                 '..((((((..(((.(((((((.........))).))))))).....)))))).......((((((...((((.((((...)))).)))))))))).....']


        ndata = {ss: {'identity': e, 'energy': en} for e, (ss, en) in enumerate(path)}
        gedges = guiding_edge_search(set(ndata.keys()))
        edata = dict()
        for (x, y) in gedges:
            if get_bpd_cache(x, y) == 1:
                edata[(x,y)] = {'saddle_energy': max(ndata[x]['energy'], ndata[y]['energy'])}
            else:
                edata[(x,y)] = {'saddle_energy': None}

        cgn, cge, cgm = top_down_coarse_graining(ndata, edata, minh = 300)

        for n in sorted(cgn, key = lambda x: cgn[x]['identity']):
            assert n in lmins

        assert sum(len(cgm[n]) for n in cgn) >= len(ndata)-len(cgn)

        for i, node in enumerate(sorted(cgn, key = lambda x: cgn[x]['identity'])):
            ne = cgn[node]['energy']
            # Calculate barrier heights to all other basins.
            barstr = ''
            for j, other in enumerate(sorted(cgn, key = lambda x: cgn[x]['identity'])):
                oe = cgn[other]['energy']
                sE = cge[(node, other)]['saddle_energy'] if (node, other) in cge else None
                if sE is not None:
                    barstr += ' {:7.2f}'.format((sE - ne)/100)
                    assert abs(i-j)==1
                else:
                    barstr += ' {:7.2f}'.format(float('nan'))
                    assert abs(i-j)!=1
            #print(barstr)

        #print()
        #print_barfile(seq, cgn, cge, cgm)

    def dont_test_minitrafo_randseq(self):
        # A random set of sequences returned by randseq -l 100 | RNAsubopt --stochBT_en=50 | sort -u
        btree = """ 
           CAAAGGCGACUCUCCUUAGACUCUAUAAAUAGUAAAUAGCUCCUAGGGACAAGGCUUACGUCCGCGUUAUUCACAUAAGUCGUCGCUUCAGUUGUGCGAC
        01 ............((((((((..((((.........)))).)).)))))).............................(((((.((.......))))))) -10.40 0 1
        02 .....((((((.(((((((...((.............))...)))))))...(((....)))...((.....))...))))))................. -10.80 0 1
        03 ....((((((..((((((((..((((.........)))).)).))))))...((.(.(((....))).).))......))))))(((......).))... -11.20 0 1
        04 ....(((((((.(((((((...((((.........))))...)))))))..(.((........)).)..........)))))))..(.(.((...)))). -11.60 0 1
        05 .....(((((..(((((((...(((((.....)..))))...)))))))...((((((.((..(.....)..)).))))))))))).............. -13.80 0 1
        06 ...(((((((..((((((....(((...........)))....))))))...((((((.((...........)).)))))))))))))((....)).... -14.20 0 1
        07 ...(.(((.....((((((...((((.........))))...))))))....(((....)))))).)...............((((.........)))). -14.60 0 1
        08 ....((((((...((((((...((((.........))))...))))))....((((((.((...........)).))))))))))))..(....)..... -15.00 0 1
        09 ..((.(((.(..(((((((...((((.........))))...)))))))...)((....)).))).)).............(((((.........))))) -15.10 0 1
        10 ...((....))..((((((...((((.........))))...))))))....((((((.................))))))(((((.........))))) -15.80 0 1
        11 ....((((((..(((((((...((((.........))))...)))))))....((........))((.....)).......))))))............. -16.00 0 1
        12 ....((((((..(((((((...((((.........))))...)))))))...((((((.(.............).))))))))))))...((......)) -16.10 0 1
        13 ....(((((((.(((((((...((.............))...))))))).((.((........)).)).........)))))))((.........))... -16.20 0 1
        14 ..........(.(((((((...((((.........))))...))))))).).((((((.(.............).))))))(((((.........))))) -16.20 0 1
        15 ...((.(.....(((((((...((((.........))))...)))))))...).))......................((((.(((.......))))))) -16.60 0 1
        16 ...(((((((...((((((...((((..(...)..))))...))))))....((((((.((...........)).)))))))))))))............ -17.00 0 1
        17 ....((((((...((((((...((((.........))))...))))))....((((((.((...........)).))))))))))))((.((...)))). -17.00 0 1
        18 ((((((((((..(((((((...((((........).)))...)))))))...((((((.((...........)).)))))))))))))...)))...... -17.20 0 1
        19 ...(((((((..(((((((...((((.........))))...)))))))...((((((.((....(.....))).)))))))))))))((....)).... -17.30 0 1
        20 ...(((((((...(((((((..((((.........)))).).))))))....((((((.((...........)).)))))))))))))............ -17.40 0 1
        21 ((((((((((..(((((((...((((.........))))...)))))))...((((((.((..(......).)).)))))))))))))...)))...... -17.70 0 1
        22 ....((((((..((((((((..((((.........)))).).)))))))...((((((.((...........)).))))))))))))............. -17.90 0 1
        23 .....(((((...((((((...((((.........))))...))))))....((((((.((...........)).))))))))))).............. -17.90 0 1
        24 (..(((((((..(((((((...(((...........)))...)))))))...((((((.((...........)).)))))))))))))..)......... -18.10 0 1
        25 ....(((((((.(((((((...((((.........))))...)))))))..(.((........)).)..........)))))))((.........))... -18.20 0 1
        26 (..(((((((..(((((((...((((.........))))...)))))))...((((((((....))).........))))))))))))..)......... -18.30 0 1
        27 ...(((((((..((((((((..((((.........)))).).)))))))...((((((.((...........)).)))))))))))))............ -18.50 0 1
        28 ((((((((((..(((((((...((((.........))))...)))))))...((((((.(.............).)))))))))))))...)))...... -18.70 0 1
        29 ...((((.....(((((((...((((.........))))...)))))))....))))........................(((((.........))))) -18.70 0 1
        30 ....((((((..(((((((...((((.........))))...)))))))...((((((.((...........)).))))))))))))...(((....))) -18.70 0 1
        31 ...(((((((..(((((((...((((.........))))...)))))))...((((((.((...........)).)))))))))))))..((...))... -18.90 0 1
        32 ....((((((..(((((((...((((.........))))...)))))))...((((((.((...........)).))))))))))))((........)). -18.90 0 1
        33 .....((((((.(((((((...((((.........))))...))))))).((.((........)).)).........))))))(((.........))).. -18.90 0 1
        34 ....((((((...((((((...((((.........))))...))))))....((((((.((...........)).))))))))))))............. -19.20 0 1
        35 ..((.(((....(((((((...((((.........))))...)))))))...(((....)))))).)).............(((((.........))))) -19.30 0 1
        36 ...(((((((...((((((...((((.........))))...))))))....((((((.((...........)).)))))))))))))............ -19.80 0 1
        37 ....((((((..(((((((...((((.........))))...)))))))...((((((.((...........)).))))))))))))............. -20.30 0 1
        38 ...(((((((..(((((((...((((.........))))...)))))))...((((((.((...........)).)))))))))))))............ -20.90 0 1
        39 ....(((((((.(((((((...((((.........))))...)))))))....((........))............)))))))................ -17.60 0 1
        """
        lmins = parse_barriers(btree, is_file = False, return_tuple = True)
        seq, md = lmins[0], RNA.md()
        myminh = 300

        ndata = {x.structure: {'energy': int(round(x.energy*100)), 'identity': x.id} for x in lmins[1:]}

        gnodes, gedges = get_guide_graph(seq, md, ndata.keys())

        assert len(gnodes) == 25
        assert len(gedges) == 240
        for nid, (ss, en) in enumerate(gnodes, 40):
            ndata[ss] = {'energy': en, 'identity': 40}

        ndata, edata = neighborhood_flooding((seq, md), ndata, gedges, minh = myminh)

        assert len(ndata) == 80
        assert len(edata) == 316

        cgn, cge, cgm = top_down_coarse_graining(ndata, edata, minh = myminh)

        #print()
        #print_barfile(seq, cgn, cge, cgm)

if __name__ == '__main__':
    unittest.main()
